import { useEffect, useMemo, useState } from "react";
import {
  archiveTask,
  deleteTask,
  downloadUrl,
  fetchProfile,
  fetchTasks,
  getAuthToken,
  loginUser,
  probeConcurrency,
  registerUser,
  runTest,
  setAuthToken,
} from "./api";
import {
  ConcurrencyProbeResponse,
  Profile,
  TaskSummary,
  TestRunForm,
  TestRunResponse,
} from "./types";

const DEFAULT_FORM: TestRunForm = {
  engine: "vllm",
  model: "qwen2.5-7b",
  input_length: 512,
  output_length: 512,
  concurrency: 4,
  loop: 2,
  warmup: false,
  auto_concurrency: false,
  execution_mode: "remote",
  scenario: "amaas",
  ssh_config: null,

  // æ¨¡å‹å¯åŠ¨é…ç½®
  auto_launch_model: false,
  model_config_name: "",
  model_path: "",
  model_tp: 1,
  model_mode: "correct",
  model_port: 30000,
  model_host: "0.0.0.0",
  stop_model_after_test: false,

  // AMaaS ç‰¹å®šé…ç½®
  amaas_ip: "",
  amaas_api_user: "admin",
  amaas_api_passwd: "123456",
  ssh_user: "",
  ssh_password: "",
  ssh_port: 22,
  request_number: 100,
  tokenizer_path: "",
  debug: false,
};

function App() {
  const [form, setForm] = useState<TestRunForm>(DEFAULT_FORM);
  const [tasks, setTasks] = useState<TaskSummary[]>([]);
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [probeInfo, setProbeInfo] = useState<ConcurrencyProbeResponse | null>(
    null,
  );
  const [profile, setProfile] = useState<Profile | null>(null);
  const [authMode, setAuthMode] = useState<"login" | "register">("login");
  const [authForm, setAuthForm] = useState({ email: "", password: "" });
  const [authError, setAuthError] = useState<string | null>(null);
  const [authLoading, setAuthLoading] = useState(false);
  const [showSSHConfig, setShowSSHConfig] = useState(false);
  const [activeTab, setActiveTab] = useState<"basic" | "performance" | "correctness">("performance");
  const [expandedSection, setExpandedSection] = useState<string | null>("existing-model");

  useEffect(() => {
    if (!getAuthToken()) {
      return;
    }
    fetchProfile()
      .then((data) => setProfile(data))
      .catch(() => {
        setAuthToken(null);
      });
  }, []);

  useEffect(() => {
    if (!profile) return;
    loadTasks();
    const timer = setInterval(loadTasks, 5000);
    return () => clearInterval(timer);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [profile]);

  const summaryColumns = useMemo(
    () => [
      { key: "avg_latency", label: "Avg Latency" },
      { key: "p95", label: "P95" },
      { key: "error_rate", label: "Error Rate" },
      { key: "throughput_token_s", label: "Tokens/s" },
    ],
    [],
  );

  async function loadTasks() {
    if (!profile) return;
    try {
      const data = await fetchTasks();
      setTasks(data.items);
    } catch (err) {
      console.error(err);
    }
  }

  function updateForm<K extends keyof TestRunForm>(
    key: K,
    value: TestRunForm[K],
  ) {
    setForm((prev) => ({ ...prev, [key]: value }));
  }

  async function handleRunTest() {
    setLoading(true);
    setMessage(null);
    setError(null);
    try {
      const response: TestRunResponse = await runTest(form);
      setMessage(
        `ä»»åŠ¡ ${response.task_id} å·²åˆ›å»ºï¼ˆå¹¶å‘ ${response.concurrency}ï¼‰`,
      );
      await loadTasks();
    } catch (err) {
      setError(err instanceof Error ? err.message : "å¯åŠ¨å¤±è´¥");
    } finally {
      setLoading(false);
    }
  }

  async function handleProbe() {
    setError(null);
    try {
      const resp = await probeConcurrency(form);
      setProbeInfo(resp);
      updateForm("concurrency", resp.suggested);
      updateForm("auto_concurrency", true);
    } catch (err) {
      setError(err instanceof Error ? err.message : "æ¢æµ‹å¤±è´¥");
    }
  }

  async function handleArchive(taskId: number) {
    setError(null);
    try {
      await archiveTask(taskId);
      await loadTasks();
    } catch (err) {
      setError(err instanceof Error ? err.message : "å½’æ¡£å¤±è´¥");
    }
  }

  async function handleDelete(taskId: number) {
    setError(null);
    try {
      await deleteTask(taskId);
      await loadTasks();
    } catch (err) {
      setError(err instanceof Error ? err.message : "åˆ é™¤å¤±è´¥");
    }
  }

  async function handleAuthSubmit() {
    setAuthError(null);
    setAuthLoading(true);
    try {
      const payload = { ...authForm };
      const fn = authMode === "login" ? loginUser : registerUser;
      const resp = await fn(payload);
      setAuthToken(resp.token);
      const profileResp = await fetchProfile();
      setProfile(profileResp);
      setAuthForm({ email: "", password: "" });
    } catch (err) {
      setAuthError(err instanceof Error ? err.message : "æ“ä½œå¤±è´¥");
    } finally {
      setAuthLoading(false);
    }
  }

  function handleLogout() {
    setAuthToken(null);
    setProfile(null);
    setTasks([]);
  }

  if (!profile) {
    return (
      <div className="cover-page">
        <div className="hero">
          <p className="eyebrow">LLM Performance Test Platform</p>
          <h1>ä¸€ç«™å¼å¤§æ¨¡å‹å‹æµ‹å¹³å°</h1>
          <p className="subhead">
            å¯é…ç½®è¾“å…¥è¾“å‡ºã€è‡ªåŠ¨æ¢æµ‹å¹¶å‘ï¼Œç”Ÿæˆ Excel æŠ¥å‘Šå¹¶æ”¯æŒå½’æ¡£/ä¸‹è½½ã€‚
          </p>
          <div className="cover-actions">
            <button
              className={authMode === "login" ? "" : "secondary"}
              onClick={() => setAuthMode("login")}
            >
              ç™»å½•
            </button>
            <button
              className={authMode === "register" ? "" : "secondary"}
              onClick={() => setAuthMode("register")}
            >
              æ³¨å†Œ
            </button>
          </div>
        </div>

        <div className="auth-card">
          <h2>{authMode === "login" ? "ç™»å½•è´¦æˆ·" : "åˆ›å»ºæ–°è´¦æˆ·"}</h2>
          <label>
            é‚®ç®±
            <input
              type="email"
              value={authForm.email}
              onChange={(e) =>
                setAuthForm((prev) => ({ ...prev, email: e.target.value }))
              }
              placeholder="example@company.com"
            />
          </label>
          <label>
            å¯†ç 
            <input
              type="password"
              value={authForm.password}
              onChange={(e) =>
                setAuthForm((prev) => ({ ...prev, password: e.target.value }))
              }
              placeholder="è‡³å°‘ 8 ä½å­—ç¬¦"
            />
          </label>
          <button onClick={handleAuthSubmit} disabled={authLoading}>
            {authMode === "login"
              ? authLoading
                ? "ç™»å½•ä¸­..."
                : "ç™»å½•"
              : authLoading
                ? "æ³¨å†Œä¸­..."
                : "æ³¨å†Œå¹¶è¿›å…¥"}
          </button>
          {authError && <div className="error">{authError}</div>}
        </div>
      </div>
    );
  }

  return (
    <div className="page">
      <header>
        <div>
          <h1>LLM æ€§èƒ½æµ‹è¯•å¹³å°</h1>
          <p>æ¬¢è¿å›æ¥ï¼Œ{profile.email}</p>
        </div>
        <div className="header-actions">
          <button className="secondary" onClick={loadTasks}>
            åˆ·æ–°
          </button>
          <button className="secondary" onClick={handleLogout}>
            é€€å‡ºç™»å½•
          </button>
        </div>
      </header>

      {/* æ ‡ç­¾é¡µåˆ‡æ¢ */}
      <div className="tabs">
        <button
          className={activeTab === "basic" ? "tab active" : "tab"}
          onClick={() => setActiveTab("basic")}
        >
          åŸºç¡€æµ‹è¯•
        </button>
        <button
          className={activeTab === "performance" ? "tab active" : "tab"}
          onClick={() => setActiveTab("performance")}
        >
          æ€§èƒ½æµ‹è¯•
        </button>
        <button
          className={activeTab === "correctness" ? "tab active" : "tab"}
          onClick={() => setActiveTab("correctness")}
        >
          æ­£ç¡®æ€§æµ‹è¯•
        </button>
      </div>

      {activeTab === "basic" && (
        <section className="panel">
          <h2>åŸºç¡€æµ‹è¯•</h2>
          <p style={{ padding: "2rem", textAlign: "center", color: "#666" }}>
            åŸºç¡€æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...
          </p>
          <p style={{ padding: "0 2rem 2rem", textAlign: "center", color: "#999", fontSize: "0.9rem" }}>
            ç”¨äºå•æ¬¡è°ƒç”¨éªŒè¯ã€æ¨¡å‹å¯ç”¨æ€§æ£€æŸ¥ç­‰åŸºç¡€åŠŸèƒ½æµ‹è¯•
          </p>
        </section>
      )}

      {activeTab === "performance" && (
        <>
          <section className="panel">
            <h2>æ‰§è¡Œæ€§èƒ½æµ‹è¯•</h2>

            {/* å¯æŠ˜å èœå• 1: æ¨¡å‹å·²è¿è¡Œï¼Œç›´æ¥æµ‹è¯• */}
            <div style={{ marginBottom: "1rem", border: "1px solid #ddd", borderRadius: "8px", overflow: "hidden" }}>
              <div
                onClick={() => setExpandedSection(expandedSection === "existing-model" ? null : "existing-model")}
                style={{
                  padding: "1rem 1.5rem",
                  backgroundColor: expandedSection === "existing-model" ? "#0066cc" : "#f5f5f5",
                  color: expandedSection === "existing-model" ? "#fff" : "#333",
                  cursor: "pointer",
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  fontWeight: "600",
                  transition: "all 0.2s"
                }}
              >
                <span>ğŸ“Š æ¨¡å‹å·²è¿è¡Œï¼Œç›´æ¥è¿›è¡Œæ€§èƒ½æµ‹è¯•</span>
                <span>{expandedSection === "existing-model" ? "â–¼" : "â–¶"}</span>
              </div>

              {expandedSection === "existing-model" && (
                <div style={{ padding: "1.5rem" }}>
                  {/* åœºæ™¯é€‰æ‹© */}
                  <div style={{ marginBottom: "1.5rem" }}>
                    <label style={{ display: "block", marginBottom: "0.5rem", fontWeight: "600", color: "#333" }}>
                      æµ‹è¯•åœºæ™¯ *
                    </label>
                    <div style={{ display: "flex", gap: "1rem" }}>
                      <label style={{ display: "flex", alignItems: "center", gap: "0.5rem", cursor: "pointer" }}>
                        <input
                          type="radio"
                          name="scenario"
                          value="ft"
                          checked={form.scenario === "ft"}
                          onChange={(e) => updateForm("scenario", e.target.value as "amaas" | "ft")}
                        />
                        <span>åŸºäº FT å®¹å™¨</span>
                      </label>
                      <label style={{ display: "flex", alignItems: "center", gap: "0.5rem", cursor: "pointer" }}>
                        <input
                          type="radio"
                          name="scenario"
                          value="amaas"
                          checked={form.scenario === "amaas"}
                          onChange={(e) => updateForm("scenario", e.target.value as "amaas" | "ft")}
                        />
                        <span>åŸºäº AMaaS</span>
                      </label>
                    </div>
                  </div>

                  {/* AMaaS é…ç½®è¡¨å• */}
                  {form.scenario === "amaas" && (
                    <>
                      <div className="form-grid">
                        <label>
                          IP åœ°å€ *
                          <input
                            value={form.amaas_ip || ""}
                            onChange={(e) => updateForm("amaas_ip", e.target.value)}
                            placeholder="192.168.1.100"
                          />
                        </label>
                        <label>
                          AMaaS ç”¨æˆ·å
                          <input
                            value={form.amaas_api_user || ""}
                            onChange={(e) => updateForm("amaas_api_user", e.target.value)}
                            placeholder="admin"
                          />
                        </label>
                        <label>
                          AMaaS å¯†ç 
                          <input
                            type="password"
                            value={form.amaas_api_passwd || ""}
                            onChange={(e) => updateForm("amaas_api_passwd", e.target.value)}
                            placeholder="123456"
                          />
                        </label>
                        <label>
                          SSH ç”¨æˆ· *
                          <input
                            value={form.ssh_user || ""}
                            onChange={(e) => updateForm("ssh_user", e.target.value)}
                            placeholder="root"
                          />
                        </label>
                        <label>
                          SSH å¯†ç 
                          <input
                            type="password"
                            value={form.ssh_password || ""}
                            onChange={(e) => updateForm("ssh_password", e.target.value)}
                            placeholder="å¯ä¸ºç©ºï¼ˆä½¿ç”¨å¯†é’¥ç™»å½•æ—¶ï¼‰"
                          />
                        </label>
                        <label>
                          SSH ç«¯å£
                          <input
                            type="number"
                            value={form.ssh_port || 22}
                            onChange={(e) => updateForm("ssh_port", Number(e.target.value))}
                          />
                        </label>
                        <label>
                          å¹¶å‘åº¦ *
                          <input
                            type="number"
                            value={form.concurrency ?? ""}
                            onChange={(e) => updateForm("concurrency", Number(e.target.value))}
                            placeholder="4"
                            min="1"
                          />
                        </label>
                        <label>
                          è¯·æ±‚æ•° *
                          <input
                            type="number"
                            value={form.request_number || ""}
                            onChange={(e) => updateForm("request_number", Number(e.target.value))}
                            placeholder="100"
                            min="1"
                          />
                        </label>
                        <label>
                          æ¨¡å‹åç§° *
                          <input
                            value={form.model}
                            onChange={(e) => updateForm("model", e.target.value)}
                            placeholder="qwen2.5-7b"
                            list="model-suggestions"
                          />
                          <datalist id="model-suggestions">
                            <option value="qwen2.5-7b" />
                            <option value="qwen2.5-14b" />
                            <option value="qwen2.5-32b" />
                            <option value="llama-3.1-8b" />
                          </datalist>
                        </label>
                        <label>
                          Tokenizer è·¯å¾„
                          <input
                            value={form.tokenizer_path || ""}
                            onChange={(e) => updateForm("tokenizer_path", e.target.value)}
                            placeholder="å¯ä¸ºç©ºï¼ˆè‡ªåŠ¨æ ¹æ®æ¨¡å‹åç§°æŸ¥æ‰¾ï¼‰"
                          />
                        </label>
                        <label>
                          è¾“å…¥é•¿åº¦ *
                          <input
                            type="number"
                            value={form.input_length}
                            onChange={(e) => updateForm("input_length", Number(e.target.value))}
                            min="1"
                          />
                        </label>
                        <label>
                          è¾“å‡ºé•¿åº¦ *
                          <input
                            type="number"
                            value={form.output_length}
                            onChange={(e) => updateForm("output_length", Number(e.target.value))}
                            min="1"
                          />
                        </label>
                        <label className="checkbox">
                          <input
                            type="checkbox"
                            checked={form.warmup}
                            onChange={(e) => updateForm("warmup", e.target.checked)}
                          />
                          å¯ç”¨ Warmup
                        </label>
                        <label className="checkbox">
                          <input
                            type="checkbox"
                            checked={form.debug || false}
                            onChange={(e) => updateForm("debug", e.target.checked)}
                          />
                          å¯ç”¨ Debug æ¨¡å¼
                          {form.debug && (
                            <small style={{ color: "#ff6600", display: "block", marginTop: "0.25rem" }}>
                              âš ï¸ Debug æ¨¡å¼å¯èƒ½ä¼šå½±å“æ€§èƒ½æµ‹è¯•ç»“æœ
                            </small>
                          )}
                        </label>
                      </div>

                      <div className="actions" style={{ marginTop: "1.5rem" }}>
                        <button onClick={handleRunTest} disabled={loading}>
                          {loading ? "æ‰§è¡Œä¸­..." : "å¯åŠ¨æµ‹è¯•"}
                        </button>
                      </div>
                      {message && <div className="success">{message}</div>}
                      {error && <div className="error">{error}</div>}
                    </>
                  )}

                  {/* FT é…ç½®è¡¨å• */}
                  {form.scenario === "ft" && (
                    <div style={{ padding: "2rem", textAlign: "center", color: "#666" }}>
                      <p>FT å®¹å™¨æµ‹è¯•é…ç½®åŠŸèƒ½å¼€å‘ä¸­...</p>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* å¯æŠ˜å èœå• 2: å¯åŠ¨æ–°æ¨¡å‹å¹¶æµ‹è¯• (å ä½) */}
            <div style={{ marginBottom: "1rem", border: "1px solid #ddd", borderRadius: "8px", overflow: "hidden" }}>
              <div
                onClick={() => setExpandedSection(expandedSection === "launch-model" ? null : "launch-model")}
                style={{
                  padding: "1rem 1.5rem",
                  backgroundColor: expandedSection === "launch-model" ? "#0066cc" : "#f5f5f5",
                  color: expandedSection === "launch-model" ? "#fff" : "#333",
                  cursor: "pointer",
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  fontWeight: "600",
                  transition: "all 0.2s"
                }}
              >
                <span>ğŸš€ å¯åŠ¨æ–°æ¨¡å‹å¹¶è¿›è¡Œæ€§èƒ½æµ‹è¯•</span>
                <span>{expandedSection === "launch-model" ? "â–¼" : "â–¶"}</span>
              </div>

              {expandedSection === "launch-model" && (
                <div style={{ padding: "1.5rem", textAlign: "center", color: "#666" }}>
                  <p>å¯åŠ¨æ–°æ¨¡å‹åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
              )}
            </div>
          </section>

          <section className="panel">
            <h2>å†å²ä»»åŠ¡</h2>
            <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>æ¨¡å‹</th>
              <th>çŠ¶æ€</th>
              {summaryColumns.map((col) => (
                <th key={col.key}>{col.label}</th>
              ))}
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {tasks.map((task) => (
              <tr key={task.id}>
                <td>{task.id}</td>
                <td>
                  <div>{task.model}</div>
                  <small>{task.parameters?.["concurrency"] ?? "-"}</small>
                </td>
                <td>{task.status}</td>
                {summaryColumns.map((col) => (
                  <td key={col.key}>
                    {task.summary?.[col.key] ?? "-"}
                  </td>
                ))}
                <td className="actions-cell">
                  <button
                    className="link"
                    disabled={!task.result_path}
                    onClick={() => window.open(downloadUrl(task.id), "_blank")}
                  >
                    ä¸‹è½½
                  </button>
                  <button
                    className="link"
                    disabled={!task.result_path}
                    onClick={() => handleArchive(task.id)}
                  >
                    å½’æ¡£
                  </button>
                  <button
                    className="link danger"
                    onClick={() => handleDelete(task.id)}
                  >
                    åˆ é™¤
                  </button>
                </td>
              </tr>
            ))}
            {!tasks.length && (
              <tr>
                <td colSpan={8}>æš‚æ— ä»»åŠ¡</td>
              </tr>
            )}
          </tbody>
        </table>
      </section>
        </>
      )}

      {activeTab === "correctness" && (
        <section className="panel">
          <h2>æ­£ç¡®æ€§æµ‹è¯•</h2>
          <p style={{ padding: "2rem", textAlign: "center", color: "#666" }}>
            æ­£ç¡®æ€§æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...
          </p>
          <p style={{ padding: "0 2rem 2rem", textAlign: "center", color: "#999", fontSize: "0.9rem" }}>
            ç”¨äºæ¨¡å‹è¾“å‡ºå‡†ç¡®æ€§éªŒè¯ã€benchmark è¯„æµ‹ç­‰åŠŸèƒ½æµ‹è¯•
          </p>
        </section>
      )}
    </div>
  );
}

export default App;

