import { useEffect, useMemo, useState } from "react";
import {
  archiveTask,
  cancelTask,
  deleteTask,
  downloadUrl,
  fetchProfile,
  fetchTasks,
  fetchTaskLogs,
  getAuthToken,
  loginUser,
  probeConcurrency,
  registerUser,
  retryTask,
  runTest,
  runPerfTest,
  setAuthToken,
} from "./api";
import {
  ConcurrencyProbeResponse,
  Profile,
  TaskSummary,
  TestRunForm,
  TestRunResponse,
} from "./types";

const DEFAULT_FORM: TestRunForm = {
  engine: "vllm",
  model: "qwen2.5-7b",
  input_length: 512,
  output_length: 512,
  concurrency: "4",
  loop: 1,
  warmup: false,
  auto_concurrency: false,
  execution_mode: "remote",
  scenario: "amaas",
  ssh_config: null,

  // æ¨¡å‹å¯åŠ¨é…ç½®
  auto_launch_model: false,
  model_config_name: "",
  model_path: "",
  model_tp: 1,
  model_mode: "correct",
  model_port: 30000,
  model_host: "0.0.0.0",
  stop_model_after_test: false,

  // AMaaS ç‰¹å®šé…ç½®
  amaas_ip: "",
  amaas_api_port: 10001,
  amaas_api_user: "admin",
  amaas_api_passwd: "123456",
  ssh_user: "",
  ssh_password: "",
  ssh_port: 22,
  request_number: "100",
  tokenizer_path: "",
  debug: false,
};

function App() {
  const [form, setForm] = useState<TestRunForm>(DEFAULT_FORM);
  const [tasks, setTasks] = useState<TaskSummary[]>([]);
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [probeInfo, setProbeInfo] = useState<ConcurrencyProbeResponse | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [authMode, setAuthMode] = useState<"login" | "register">("login");
  const [authForm, setAuthForm] = useState({ email: "", password: "" });
  const [authError, setAuthError] = useState<string | null>(null);
  const [authLoading, setAuthLoading] = useState(false);
  const [activeTab, setActiveTab] = useState<"basic" | "performance" | "correctness">("performance");
  const [expandedSection, setExpandedSection] = useState<string | null>("existing-model");
  const [showLogsModal, setShowLogsModal] = useState(false);
  const [currentLogs, setCurrentLogs] = useState<string>("");
  const [logsTaskId, setLogsTaskId] = useState<number | null>(null);

  // Password visibility state
  const [showPassword, setShowPassword] = useState({
    auth: false,
    ssh: false,
    amaas: false,
  });

  // Pagination state
  const [currentPage, setCurrentPage] = useState(1);
  const [pageSize] = useState(20);
  const [totalTasks, setTotalTasks] = useState(0);
  const [totalPages, setTotalPages] = useState(0);

  useEffect(() => {
    if (!getAuthToken()) {
      return;
    }
    fetchProfile()
      .then((data) => setProfile(data))
      .catch(() => {
        setAuthToken(null);
      });
  }, []);

  useEffect(() => {
    if (!profile) return;
    loadTasks();
    const timer = setInterval(loadTasks, 5000);
    return () => clearInterval(timer);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [profile, currentPage]);

  const summaryColumns = useMemo(
    () => [
      { key: "avg_latency", label: "Avg Latency" },
      { key: "p95", label: "P95" },
      { key: "error_rate", label: "Error Rate" },
      { key: "throughput_token_s", label: "Tokens/s" },
    ],
    [],
  );

  async function loadTasks() {
    if (!profile) return;
    try {
      const data = await fetchTasks({ page: currentPage, page_size: pageSize });
      setTasks(data.items);
      setTotalTasks(data.total);
      setTotalPages(data.total_pages);
    } catch (err) {
      console.error(err);
    }
  }

  function updateForm<K extends keyof TestRunForm>(
    key: K,
    value: TestRunForm[K],
  ) {
    setForm((prev) => ({ ...prev, [key]: value }));
  }

  async function handleRunTest() {
    setLoading(true);
    setMessage(null);
    setError(null);
    try {
      const response: TestRunResponse = await runTest(form);
      setMessage(
        `ä»»åŠ¡ ${response.task_id} å·²åˆ›å»ºï¼ˆå¹¶å‘ ${response.concurrency}ï¼‰`,
      );
      await loadTasks();
    } catch (err) {
      setError(err instanceof Error ? err.message : "å¯åŠ¨å¤±è´¥");
    } finally {
      setLoading(false);
    }
  }

  async function handleProbe() {
    setError(null);
    try {
      const resp = await probeConcurrency(form);
      setProbeInfo(resp);
      updateForm("concurrency", resp.suggested.toString());
      updateForm("auto_concurrency", true);
    } catch (err) {
      setError(err instanceof Error ? err.message : "æ¢æµ‹å¤±è´¥");
    }
  }

  async function handleArchive(taskId: number) {
    setError(null);
    try {
      await archiveTask(taskId);
      await loadTasks();
    } catch (err) {
      setError(err instanceof Error ? err.message : "å½’æ¡£å¤±è´¥");
    }
  }

  async function handleDelete(taskId: number) {
    setError(null);
    try {
      await deleteTask(taskId);
      await loadTasks();
    } catch (err) {
      setError(err instanceof Error ? err.message : "åˆ é™¤å¤±è´¥");
    }
  }

  async function handleCancel(taskId: number) {
    setError(null);
    try {
      const response = await cancelTask(taskId);
      if (response.cancelled) {
        await loadTasks();
      } else {
        setError(response.message);
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : "å–æ¶ˆå¤±è´¥");
    }
  }

  async function handleAuthSubmit() {
    setAuthError(null);
    setAuthLoading(true);
    try {
      const payload = { ...authForm };
      const fn = authMode === "login" ? loginUser : registerUser;
      const resp = await fn(payload);
      setAuthToken(resp.token);
      const profileResp = await fetchProfile();
      setProfile(profileResp);
      setAuthForm({ email: "", password: "" });
    } catch (err) {
      setAuthError(err instanceof Error ? err.message : "æ“ä½œå¤±è´¥");
    } finally {
      setAuthLoading(false);
    }
  }

  function handleLogout() {
    setAuthToken(null);
    setProfile(null);
    setTasks([]);
  }

  async function handleViewLogs(taskId: number) {
    setError(null);
    try {
      const response = await fetchTaskLogs(taskId);
      setCurrentLogs(response.logs);
      setLogsTaskId(taskId);
      setShowLogsModal(true);
    } catch (err) {
      setError(err instanceof Error ? err.message : "è·å–æ—¥å¿—å¤±è´¥");
    }
  }

  async function handleRetry(taskId: number) {
    setError(null);
    setMessage(null);
    try {
      const response = await retryTask(taskId);
      setMessage(`ä»»åŠ¡ ${taskId} å·²é‡æ–°æäº¤ï¼Œæ–°ä»»åŠ¡ ID: ${response.new_task_id}`);
      await loadTasks();
    } catch (err) {
      setError(err instanceof Error ? err.message : "é‡è¯•å¤±è´¥");
    }
  }

  if (!profile) {
    return (
      <div className="cover-page">
        <div className="hero">
          <p className="eyebrow">LLM Performance Test Platform</p>
          <h1>ä¸€ç«™å¼å¤§æ¨¡å‹å‹æµ‹å¹³å°</h1>
          <p className="subhead">
            å¯é…ç½®è¾“å…¥è¾“å‡ºã€è‡ªåŠ¨æ¢æµ‹å¹¶å‘ï¼Œç”Ÿæˆ Excel æŠ¥å‘Šå¹¶æ”¯æŒå½’æ¡£/ä¸‹è½½ã€‚
          </p>
          <div className="cover-actions">
            <button
              className={authMode === "login" ? "" : "secondary"}
              onClick={() => setAuthMode("login")}
            >
              ç™»å½•
            </button>
            <button
              className={authMode === "register" ? "" : "secondary"}
              onClick={() => setAuthMode("register")}
            >
              æ³¨å†Œ
            </button>
          </div>
        </div>

        <div className="auth-card">
          <h2>{authMode === "login" ? "ç™»å½•è´¦æˆ·" : "åˆ›å»ºæ–°è´¦æˆ·"}</h2>
          <label>
            é‚®ç®±
            <input
              type="email"
              value={authForm.email}
              onChange={(e) =>
                setAuthForm((prev) => ({ ...prev, email: e.target.value }))
              }
              placeholder="example@company.com"
            />
          </label>
          <label>
            å¯†ç 
            <div style={{ position: "relative", display: "flex", alignItems: "center" }}>
              <input
                type={showPassword.auth ? "text" : "password"}
                value={authForm.password}
                onChange={(e) =>
                  setAuthForm((prev) => ({ ...prev, password: e.target.value }))
                }
                placeholder="è‡³å°‘ 8 ä½å­—ç¬¦"
                style={{ flex: 1, paddingRight: "2.5rem" }}
              />
              <button
                type="button"
                onClick={() => setShowPassword(prev => ({ ...prev, auth: !prev.auth }))}
                style={{
                  position: "absolute",
                  right: "0.5rem",
                  background: "none",
                  border: "none",
                  cursor: "pointer",
                  padding: "0.25rem",
                  fontSize: "1rem",
                  color: "#666",
                }}
                title={showPassword.auth ? "éšè—å¯†ç " : "æ˜¾ç¤ºå¯†ç "}
              >
                {showPassword.auth ? "ğŸ™ˆ" : "ğŸ‘ï¸"}
              </button>
            </div>
          </label>
          <button onClick={handleAuthSubmit} disabled={authLoading}>
            {authMode === "login"
              ? authLoading
                ? "ç™»å½•ä¸­..."
                : "ç™»å½•"
              : authLoading
                ? "æ³¨å†Œä¸­..."
                : "æ³¨å†Œå¹¶è¿›å…¥"}
          </button>
          {authError && <div className="error">{authError}</div>}
        </div>
      </div>
    );
  }

  return (
    <div className="page">
      <header>
        <div>
          <h1>LLM æ€§èƒ½æµ‹è¯•å¹³å°</h1>
          <p>æ¬¢è¿å›æ¥ï¼Œ{profile.email}</p>
        </div>
        <div className="header-actions">
          <button className="secondary" onClick={loadTasks}>
            åˆ·æ–°
          </button>
          <button className="secondary" onClick={handleLogout}>
            é€€å‡ºç™»å½•
          </button>
        </div>
      </header>

      {/* æ ‡ç­¾é¡µåˆ‡æ¢ */}
      <div className="tabs">
        <button
          className={activeTab === "basic" ? "tab active" : "tab"}
          onClick={() => setActiveTab("basic")}
        >
          åŸºç¡€æµ‹è¯•
        </button>
        <button
          className={activeTab === "performance" ? "tab active" : "tab"}
          onClick={() => setActiveTab("performance")}
        >
          æ€§èƒ½æµ‹è¯•
        </button>
        <button
          className={activeTab === "correctness" ? "tab active" : "tab"}
          onClick={() => setActiveTab("correctness")}
        >
          æ­£ç¡®æ€§æµ‹è¯•
        </button>
      </div>

      {activeTab === "basic" && (
        <section className="panel">
          <h2>åŸºç¡€æµ‹è¯• (Pytest)</h2>

          {/* åœºæ™¯é€‰æ‹© */}
          <div style={{ marginBottom: "1.5rem" }}>
            <label style={{ fontWeight: "600", marginBottom: "0.5rem", display: "block" }}>
              æµ‹è¯•åœºæ™¯
            </label>
            <div style={{ display: "flex", gap: "2rem" }}>
              <label style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                <input
                  type="radio"
                  name="basic-scenario"
                  value="amaas"
                  checked={form.scenario === "amaas"}
                  onChange={(e) => updateForm("scenario", e.target.value as "ft" | "amaas")}
                />
                <span>åŸºäº AMaaS</span>
              </label>
              <label style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                <input
                  type="radio"
                  name="basic-scenario"
                  value="ft"
                  checked={form.scenario === "ft"}
                  onChange={(e) => updateForm("scenario", e.target.value as "ft" | "amaas")}
                />
                <span>åŸºäº FT</span>
              </label>
            </div>
          </div>

          {/* SSH é…ç½® */}
          <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>SSH é…ç½®</h3>
          <div className="form-grid">
            <label>
              SSH ä¸»æœº *
              <input
                type="text"
                value={form.amaas_ip || ""}
                onChange={(e) => updateForm("amaas_ip", e.target.value)}
                placeholder="ä¾‹å¦‚: 192.168.1.100"
                required
              />
            </label>

            <label>
              SSH ç”¨æˆ· *
              <input
                type="text"
                value={form.ssh_user || ""}
                onChange={(e) => updateForm("ssh_user", e.target.value)}
                placeholder="SSH ç™»å½•ç”¨æˆ·å"
                required
              />
            </label>

            <label>
              SSH å¯†ç 
              <div style={{ position: "relative", display: "flex", alignItems: "center" }}>
                <input
                  type={showPassword.ssh ? "text" : "password"}
                  value={form.ssh_password || ""}
                  onChange={(e) => updateForm("ssh_password", e.target.value)}
                  placeholder="SSH å¯†ç "
                  style={{ flex: 1, paddingRight: "2.5rem" }}
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(prev => ({ ...prev, ssh: !prev.ssh }))}
                  style={{
                    position: "absolute",
                    right: "0.5rem",
                    background: "none",
                    border: "none",
                    cursor: "pointer",
                    padding: "0.25rem",
                    fontSize: "1rem",
                    color: "#666",
                  }}
                  title={showPassword.ssh ? "éšè—å¯†ç " : "æ˜¾ç¤ºå¯†ç "}
                >
                  {showPassword.ssh ? "ğŸ™ˆ" : "ğŸ‘ï¸"}
                </button>
              </div>
            </label>

            <label>
              SSH ç«¯å£
              <input
                type="number"
                value={form.ssh_port === undefined ? "" : form.ssh_port}
                onChange={(e) => updateForm("ssh_port", e.target.value === "" ? undefined : parseInt(e.target.value))}
                placeholder="é»˜è®¤: 22"
              />
            </label>
          </div>

          {/* æµ‹è¯•é…ç½® */}
          <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æµ‹è¯•é…ç½®</h3>
          <div className="form-grid">
            <label>
              æµ‹è¯•è·¯å¾„
              <input
                type="text"
                value={form.testpaths || ""}
                onChange={(e) => updateForm("testpaths", e.target.value)}
                placeholder={`é»˜è®¤: testcases/sanity_check/${form.scenario}/test_${form.scenario}.py`}
              />
              <small style={{ color: "#666" }}>ä¸å¡«åˆ™æ ¹æ®åœºæ™¯è‡ªåŠ¨é€‰æ‹©</small>
            </label>

            <label>
              æµ‹è¯•çº§åˆ«
              <input
                type="text"
                value={form.case_level || ""}
                onChange={(e) => updateForm("case_level", e.target.value)}
                placeholder="ä¾‹å¦‚: amaas_ci_sanity_check"
              />
            </label>

            <label>
              æ¨¡å‹ä¼˜å…ˆçº§
              <input
                type="text"
                value={form.model_priority || ""}
                onChange={(e) => updateForm("model_priority", e.target.value)}
                placeholder="ä¾‹å¦‚: DeepSeek-V3,Qwen2.5-72B"
              />
            </label>
          </div>

          {/* é€šçŸ¥é…ç½®ï¼ˆå¯é€‰ï¼‰ */}
          <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>é€šçŸ¥é…ç½®ï¼ˆå¯é€‰ï¼‰</h3>
          <div className="form-grid">
            <label>
              é£ä¹¦ç”¨æˆ·
              <input
                type="text"
                value={form.lark_user || ""}
                onChange={(e) => updateForm("lark_user", e.target.value)}
                placeholder="é£ä¹¦ç”¨æˆ·å"
              />
            </label>

            <label>
              ä¸»é¢˜
              <input
                type="text"
                value={form.topic || ""}
                onChange={(e) => updateForm("topic", e.target.value)}
                placeholder="æµ‹è¯•ä¸»é¢˜"
              />
            </label>

            <label>
              é€šçŸ¥ç»„
              <input
                type="text"
                value={form.notify_group || ""}
                onChange={(e) => updateForm("notify_group", e.target.value)}
                placeholder="ä¾‹å¦‚: oc_e005f4612602e5af93d6272c0e8a1355"
              />
            </label>
          </div>

          {/* æŠ¥å‘Šé…ç½®ï¼ˆå¯é€‰ï¼‰ */}
          <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æŠ¥å‘Šé…ç½®ï¼ˆå¯é€‰ï¼‰</h3>
          <div className="form-grid">
            <label>
              æŠ¥å‘ŠæœåŠ¡å™¨
              <input
                type="text"
                value={form.report_server || ""}
                onChange={(e) => updateForm("report_server", e.target.value)}
                placeholder="ä¾‹å¦‚: 192.168.110.11:9080"
              />
            </label>

            <label>
              æŠ¥å‘Š URL
              <input
                type="text"
                value={form.report_url || ""}
                onChange={(e) => updateForm("report_url", e.target.value)}
                placeholder="ä¾‹å¦‚: job/my-job/123/allure/"
              />
            </label>
          </div>

          {/* é¢å¤–å‚æ•°ï¼ˆå¯é€‰ï¼‰ */}
          <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>é¢å¤–å‚æ•°ï¼ˆå¯é€‰ï¼‰</h3>
          <div className="form-grid">
            <label>
              Pytest å‚æ•°
              <input
                type="text"
                value={form.pytest_args || ""}
                onChange={(e) => updateForm("pytest_args", e.target.value)}
                placeholder="ä¾‹å¦‚: -v -s --maxfail=1"
              />
              <small style={{ color: "#666" }}>é¢å¤–çš„ pytest å‘½ä»¤è¡Œå‚æ•°ï¼Œç©ºæ ¼åˆ†éš”</small>
            </label>
          </div>

          {/* æ“ä½œæŒ‰é’® */}
          <div style={{ marginTop: "1.5rem", display: "flex", gap: "1rem" }}>
            <button
              onClick={async () => {
                if (!form.amaas_ip || !form.ssh_user) {
                  setError("è¯·å¡«å†™å¿…å¡«é¡¹ï¼šSSH ä¸»æœºå’Œç”¨æˆ·");
                  return;
                }

                setLoading(true);
                setError("");
                setMessage("");

                try {
                  const ssh_config = {
                    host: form.amaas_ip,
                    port: form.ssh_port || 22,
                    user: form.ssh_user,
                    auth_type: "password" as const,
                    password: form.ssh_password || undefined,
                    timeout: 30,
                  };

                  const payload = {
                    scenario: form.scenario,
                    ssh_config,
                    testpaths: form.testpaths || undefined,
                    case_level: form.case_level || undefined,
                    model_priority: form.model_priority || undefined,
                    lark_user: form.lark_user || undefined,
                    topic: form.topic || undefined,
                    notify_group: form.notify_group || undefined,
                    report_server: form.report_server || undefined,
                    report_url: form.report_url || undefined,
                    pytest_args: form.pytest_args || undefined,
                  };

                  const response = await fetch(`${API_BASE_URL}/basic-tests/run`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                  });

                  if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "æµ‹è¯•å¯åŠ¨å¤±è´¥");
                  }

                  const result = await response.json();
                  setMessage(`åŸºç¡€æµ‹è¯•å·²æäº¤ï¼ä»»åŠ¡ ID: ${result.task_id}`);
                  await fetchTasks();
                } catch (err: any) {
                  setError(err.message || "æµ‹è¯•å¯åŠ¨å¤±è´¥");
                } finally {
                  setLoading(false);
                }
              }}
              disabled={loading}
            >
              {loading ? "å¯åŠ¨ä¸­..." : "è¿è¡ŒåŸºç¡€æµ‹è¯•"}
            </button>
          </div>

          {/* æ¶ˆæ¯æ˜¾ç¤º */}
          {message && <div className="success" style={{ marginTop: "1rem" }}>{message}</div>}
          {error && <div className="error" style={{ marginTop: "1rem" }}>{error}</div>}
        </section>
      )}

      {activeTab === "performance" && (
        <div>
          {/* ç¬¬ä¸€ä¸ªå¯æŠ˜å èœå•ï¼šå·²æœ‰è¿è¡Œä¸­æ¨¡å‹ */}
          <section className="panel">
            <div
              className="collapsible-header"
              onClick={() =>
                setExpandedSection(
                  expandedSection === "existing-model" ? null : "existing-model"
                )
              }
              style={{
                cursor: "pointer",
                padding: "1rem",
                borderBottom:
                  expandedSection === "existing-model"
                    ? "1px solid #e0e0e0"
                    : "none",
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
              }}
            >
              <h2 style={{ margin: 0 }}>ğŸ“Š æ¨¡å‹å·²è¿è¡Œï¼Œç›´æ¥è¿›è¡Œæ€§èƒ½æµ‹è¯•</h2>
              <span style={{ fontSize: "1.5rem" }}>
                {expandedSection === "existing-model" ? "â–¼" : "â–¶"}
              </span>
            </div>

            {expandedSection === "existing-model" && (
              <div style={{ padding: "1.5rem" }}>
                {/* åœºæ™¯é€‰æ‹© */}
                <div style={{ marginBottom: "1.5rem" }}>
                  <label style={{ fontWeight: "600", marginBottom: "0.5rem", display: "block" }}>
                    æµ‹è¯•åœºæ™¯
                  </label>
                  <div style={{ display: "flex", gap: "2rem" }}>
                    <label style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                      <input
                        type="radio"
                        name="scenario"
                        value="ft"
                        checked={form.scenario === "ft"}
                        onChange={(e) => updateForm("scenario", e.target.value as "ft" | "amaas")}
                      />
                      <span>åŸºäº FT</span>
                    </label>
                    <label style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                      <input
                        type="radio"
                        name="scenario"
                        value="amaas"
                        checked={form.scenario === "amaas"}
                        onChange={(e) => updateForm("scenario", e.target.value as "ft" | "amaas")}
                      />
                      <span>åŸºäº AMaaS</span>
                    </label>
                  </div>
                </div>

                {/* AMaaS é…ç½®è¡¨å• */}
                {form.scenario === "amaas" && (
                  <div>
                    {/* è¿æ¥é…ç½® */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>è¿æ¥é…ç½®</h3>
                    <div className="form-grid">
                      <label>
                        AMaaS IP *
                        <input
                          type="text"
                          value={form.amaas_ip || ""}
                          onChange={(e) => updateForm("amaas_ip", e.target.value)}
                          placeholder="ä¾‹å¦‚: 192.168.1.100"
                          required
                        />
                      </label>

                      <label>
                        AMaaS ç”¨æˆ·å
                        <input
                          type="text"
                          value={form.amaas_api_user || "admin"}
                          onChange={(e) => updateForm("amaas_api_user", e.target.value)}
                          placeholder="é»˜è®¤: admin"
                        />
                      </label>

                      <label>
                        AMaaS å¯†ç 
                        <div style={{ position: "relative", display: "flex", alignItems: "center" }}>
                          <input
                            type={showPassword.amaas ? "text" : "password"}
                            value={form.amaas_api_passwd || "123456"}
                            onChange={(e) => updateForm("amaas_api_passwd", e.target.value)}
                            placeholder="é»˜è®¤: 123456"
                            style={{ flex: 1, paddingRight: "2.5rem" }}
                          />
                          <button
                            type="button"
                            onClick={() => setShowPassword(prev => ({ ...prev, amaas: !prev.amaas }))}
                            style={{
                              position: "absolute",
                              right: "0.5rem",
                              background: "none",
                              border: "none",
                              cursor: "pointer",
                              padding: "0.25rem",
                              fontSize: "1rem",
                              color: "#666",
                            }}
                            title={showPassword.amaas ? "éšè—å¯†ç " : "æ˜¾ç¤ºå¯†ç "}
                          >
                            {showPassword.amaas ? "ğŸ™ˆ" : "ğŸ‘ï¸"}
                          </button>
                        </div>
                      </label>
                    </div>

                    {/* SSH é…ç½® */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>SSH é…ç½®</h3>
                    <div className="form-grid">
                      <label>
                        SSH ç”¨æˆ· *
                        <input
                          type="text"
                          value={form.ssh_user || ""}
                          onChange={(e) => updateForm("ssh_user", e.target.value)}
                          placeholder="SSH ç™»å½•ç”¨æˆ·å"
                          required
                        />
                      </label>

                      <label>
                        SSH å¯†ç 
                        <input
                          type="password"
                          value={form.ssh_password || ""}
                          onChange={(e) => updateForm("ssh_password", e.target.value)}
                          placeholder="SSH å¯†ç ï¼ˆå¯é€‰ï¼Œæ”¯æŒ key ç™»å½•ï¼‰"
                        />
                      </label>

                      <label>
                        SSH ç«¯å£
                        <input
                          type="number"
                          value={form.ssh_port || 22}
                          onChange={(e) => updateForm("ssh_port", parseInt(e.target.value))}
                          placeholder="é»˜è®¤: 22"
                        />
                      </label>
                    </div>

                    {/* æµ‹è¯•å‚æ•° */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æµ‹è¯•å‚æ•°</h3>
                    <div className="form-grid">
                      <label>
                        å¹¶å‘åº¦ *
                        <input
                          type="text"
                          value={form.concurrency || ""}
                          onChange={(e) => updateForm("concurrency", e.target.value)}
                          onBlur={(e) => updateForm("concurrency", e.target.value.trim())}
                          placeholder="ä¾‹å¦‚: 4 æˆ– 1 10 20 30 40"
                          required
                        />
                      </label>

                      <label>
                        è¯·æ±‚æ•° *
                        <input
                          type="text"
                          value={form.request_number || ""}
                          onChange={(e) => updateForm("request_number", e.target.value)}
                          onBlur={(e) => updateForm("request_number", e.target.value.trim())}
                          placeholder="ä¾‹å¦‚: 100 æˆ– 10 50 100 200"
                          required
                        />
                      </label>

                      <label>
                        æµ‹è¯•è½®æ¬¡
                        <input
                          type="number"
                          value={form.loop || 1}
                          onChange={(e) => updateForm("loop", parseInt(e.target.value))}
                          placeholder="é»˜è®¤: 1"
                          min="1"
                        />
                      </label>

                      <label>
                        è¾“å…¥é•¿åº¦ *
                        <input
                          type="number"
                          value={form.input_length}
                          onChange={(e) => updateForm("input_length", parseInt(e.target.value))}
                          placeholder="ä¾‹å¦‚: 512"
                          required
                        />
                      </label>

                      <label>
                        è¾“å‡ºé•¿åº¦ *
                        <input
                          type="number"
                          value={form.output_length}
                          onChange={(e) => updateForm("output_length", parseInt(e.target.value))}
                          placeholder="ä¾‹å¦‚: 512"
                          required
                        />
                      </label>
                    </div>

                    {/* æ¨¡å‹é…ç½® */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æ¨¡å‹é…ç½®</h3>
                    <div className="form-grid">
                      <label>
                        æ¨¡å‹åç§° *
                        <input
                          type="text"
                          list="model-suggestions"
                          value={form.model}
                          onChange={(e) => updateForm("model", e.target.value)}
                          placeholder="é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§°"
                          required
                        />
                        <datalist id="model-suggestions">
                          <option value="qwen2.5-7b" />
                          <option value="qwen2.5-14b" />
                          <option value="qwen2.5-32b" />
                          <option value="llama-3.1-8b" />
                          <option value="llama-3.1-70b" />
                        </datalist>
                      </label>

                      <label>
                        Tokenizer è·¯å¾„
                        <input
                          type="text"
                          value={form.tokenizer_path || ""}
                          onChange={(e) => updateForm("tokenizer_path", e.target.value)}
                          placeholder="å¯é€‰ï¼Œé»˜è®¤æ ¹æ®æ¨¡å‹åç§°è‡ªåŠ¨æŸ¥æ‰¾"
                        />
                      </label>
                    </div>

                    {/* æµ‹è¯•é€‰é¡¹ */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æµ‹è¯•é€‰é¡¹</h3>
                    <div className="form-grid">
                      <label>
                        Warmup
                        <input
                          type="checkbox"
                          checked={form.warmup}
                          onChange={(e) => updateForm("warmup", e.target.checked)}
                        />
                      </label>

                      <label>
                        Debug æ¨¡å¼
                        <input
                          type="checkbox"
                          checked={form.debug || false}
                          onChange={(e) => updateForm("debug", e.target.checked)}
                        />
                      </label>
                    </div>
                    {form.debug && (
                      <small style={{ color: "#ff6b35", marginTop: "0.5rem", display: "block" }}>
                        âš ï¸ å¼€å¯ Debug å¯èƒ½ä¼šå½±å“æ€§èƒ½æµ‹è¯•ç»“æœ
                      </small>
                    )}
                  </div>
                )}

                {/* FT é…ç½®è¡¨å• */}
                {form.scenario === "ft" && (
                  <div>
                    {/* è¿æ¥é…ç½® */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>è¿æ¥é…ç½®</h3>
                    <div className="form-grid">
                      <label>
                        API IP *
                        <input
                          type="text"
                          value={form.amaas_ip || ""}
                          onChange={(e) => updateForm("amaas_ip", e.target.value)}
                          placeholder="ä¾‹å¦‚: 192.168.1.100"
                          required
                        />
                      </label>

                      <label>
                        API Port *
                        <input
                          type="number"
                          value={form.model_port || 30000}
                          onChange={(e) => updateForm("model_port", parseInt(e.target.value))}
                          placeholder="ä¾‹å¦‚: 30000"
                          required
                        />
                      </label>
                    </div>

                    {/* SSH é…ç½® */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>SSH é…ç½®</h3>
                    <div className="form-grid">
                      <label>
                        SSH ç”¨æˆ· *
                        <input
                          type="text"
                          value={form.ssh_user || ""}
                          onChange={(e) => updateForm("ssh_user", e.target.value)}
                          placeholder="SSH ç™»å½•ç”¨æˆ·å"
                          required
                        />
                      </label>

                      <label>
                        SSH å¯†ç 
                        <input
                          type="password"
                          value={form.ssh_password || ""}
                          onChange={(e) => updateForm("ssh_password", e.target.value)}
                          placeholder="SSH å¯†ç ï¼ˆå¯é€‰ï¼Œæ”¯æŒ key ç™»å½•ï¼‰"
                        />
                      </label>

                      <label>
                        SSH ç«¯å£
                        <input
                          type="number"
                          value={form.ssh_port || 22}
                          onChange={(e) => updateForm("ssh_port", parseInt(e.target.value))}
                          placeholder="é»˜è®¤: 22"
                        />
                      </label>
                    </div>

                    {/* æµ‹è¯•å‚æ•° */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æµ‹è¯•å‚æ•°</h3>
                    <div className="form-grid">
                      <label>
                        å¹¶å‘åº¦ *
                        <input
                          type="text"
                          value={form.concurrency || ""}
                          onChange={(e) => updateForm("concurrency", e.target.value)}
                          onBlur={(e) => updateForm("concurrency", e.target.value.trim())}
                          placeholder="ä¾‹å¦‚: 4 æˆ– 1 10 20 30 40"
                          required
                        />
                      </label>

                      <label>
                        è¯·æ±‚æ•° *
                        <input
                          type="text"
                          value={form.request_number || ""}
                          onChange={(e) => updateForm("request_number", e.target.value)}
                          onBlur={(e) => updateForm("request_number", e.target.value.trim())}
                          placeholder="ä¾‹å¦‚: 100 æˆ– 10 50 100 200"
                          required
                        />
                      </label>

                      <label>
                        æµ‹è¯•è½®æ¬¡
                        <input
                          type="number"
                          value={form.loop || 1}
                          onChange={(e) => updateForm("loop", parseInt(e.target.value))}
                          placeholder="é»˜è®¤: 1"
                          min="1"
                        />
                      </label>

                      <label>
                        è¾“å…¥é•¿åº¦ *
                        <input
                          type="number"
                          value={form.input_length}
                          onChange={(e) => updateForm("input_length", parseInt(e.target.value))}
                          placeholder="ä¾‹å¦‚: 512"
                          required
                        />
                      </label>

                      <label>
                        è¾“å‡ºé•¿åº¦ *
                        <input
                          type="number"
                          value={form.output_length}
                          onChange={(e) => updateForm("output_length", parseInt(e.target.value))}
                          placeholder="ä¾‹å¦‚: 512"
                          required
                        />
                      </label>
                    </div>

                    {/* æ¨¡å‹é…ç½® */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æ¨¡å‹é…ç½®</h3>
                    <div className="form-grid">
                      <label>
                        æ¨¡å‹åç§° *
                        <input
                          type="text"
                          list="model-suggestions-ft"
                          value={form.model}
                          onChange={(e) => updateForm("model", e.target.value)}
                          placeholder="é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§°"
                          required
                        />
                        <datalist id="model-suggestions-ft">
                          <option value="qwen2.5-7b" />
                          <option value="qwen2.5-14b" />
                          <option value="qwen2.5-32b" />
                          <option value="llama-3.1-8b" />
                          <option value="llama-3.1-70b" />
                        </datalist>
                      </label>

                      <label>
                        Tokenizer è·¯å¾„
                        <input
                          type="text"
                          value={form.tokenizer_path || ""}
                          onChange={(e) => updateForm("tokenizer_path", e.target.value)}
                          placeholder="å¯é€‰ï¼Œé»˜è®¤æ ¹æ®æ¨¡å‹åç§°è‡ªåŠ¨æŸ¥æ‰¾"
                        />
                      </label>
                    </div>

                    {/* æµ‹è¯•é€‰é¡¹ */}
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æµ‹è¯•é€‰é¡¹</h3>
                    <div className="form-grid">
                      <label>
                        Warmup
                        <input
                          type="checkbox"
                          checked={form.warmup}
                          onChange={(e) => updateForm("warmup", e.target.checked)}
                        />
                      </label>

                      <label>
                        Debug æ¨¡å¼
                        <input
                          type="checkbox"
                          checked={form.debug || false}
                          onChange={(e) => updateForm("debug", e.target.checked)}
                        />
                      </label>
                    </div>
                    {form.debug && (
                      <small style={{ color: "#ff6b35", marginTop: "0.5rem", display: "block" }}>
                        âš ï¸ å¼€å¯ Debug å¯èƒ½ä¼šå½±å“æ€§èƒ½æµ‹è¯•ç»“æœ
                      </small>
                    )}
                  </div>
                )}

                {/* æ“ä½œæŒ‰é’® */}
                <div style={{ marginTop: "1.5rem", display: "flex", gap: "1rem" }}>
                  <button
                    onClick={async () => {
                      setLoading(true);
                      setMessage(null);
                      setError(null);
                      try {
                        const payload = {
                          base: form.scenario as "amaas" | "ft",
                          skip_launch: true,
                          ip: form.amaas_ip || "",
                          port: form.scenario === "amaas" ? 10011 : form.model_port,
                          model: form.model,
                          tokenizer_path: form.tokenizer_path || undefined,
                          ssh_user: form.ssh_user || "",
                          ssh_password: form.ssh_password || undefined,
                          ssh_port: form.ssh_port || 22,
                          parallel: form.concurrency || "1",
                          number: form.request_number || "100",
                          input_length: form.input_length,
                          output_length: form.output_length,
                          loop: form.loop || 1,
                          debug: form.debug || false,
                          warmup: form.warmup,
                          keep_model: true,
                        };

                        const response = await runPerfTest(payload);
                        setMessage(
                          `ä»»åŠ¡ ${response.task_id} å·²åˆ›å»ºï¼ˆå¹¶å‘ ${response.concurrency}ï¼‰`,
                        );
                        await loadTasks();
                      } catch (err) {
                        setError(err instanceof Error ? err.message : "å¯åŠ¨å¤±è´¥");
                      } finally {
                        setLoading(false);
                      }
                    }}
                    disabled={loading}
                  >
                    {loading ? "æµ‹è¯•ä¸­..." : "å¼€å§‹æµ‹è¯•"}
                  </button>
                </div>

                {/* æ¶ˆæ¯æ˜¾ç¤º */}
                {message && <div className="success" style={{ marginTop: "1rem" }}>{message}</div>}
                {error && <div className="error" style={{ marginTop: "1rem" }}>{error}</div>}
              </div>
            )}
          </section>

          {/* ç¬¬äºŒä¸ªå¯æŠ˜å èœå•ï¼šæ‹‰èµ·æ¨¡å‹å¹¶æµ‹è¯• */}
          <section className="panel" style={{ marginTop: "1rem" }}>
            <div
              className="collapsible-header"
              onClick={() =>
                setExpandedSection(
                  expandedSection === "launch-model" ? null : "launch-model"
                )
              }
              style={{
                cursor: "pointer",
                padding: "1rem",
                borderBottom:
                  expandedSection === "launch-model"
                    ? "1px solid #e0e0e0"
                    : "none",
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
              }}
            >
              <h2 style={{ margin: 0 }}>ğŸš€ æ‹‰èµ·æ¨¡å‹å¹¶è¿›è¡Œæ€§èƒ½æµ‹è¯•</h2>
              <span style={{ fontSize: "1.5rem" }}>
                {expandedSection === "launch-model" ? "â–¼" : "â–¶"}
              </span>
            </div>

            {expandedSection === "launch-model" && (
              <div style={{ padding: "1.5rem" }}>
                {/* åœºæ™¯é€‰æ‹© */}
                <div style={{ marginBottom: "1.5rem" }}>
                  <label style={{ fontWeight: "600", marginBottom: "0.5rem", display: "block" }}>
                    æµ‹è¯•åœºæ™¯
                  </label>
                  <div style={{ display: "flex", gap: "2rem" }}>
                    <label style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                      <input
                        type="radio"
                        name="scenario-launch"
                        value="ft"
                        checked={form.scenario === "ft"}
                        onChange={(e) => updateForm("scenario", e.target.value as "ft" | "amaas")}
                      />
                      <span>åŸºäº FT</span>
                    </label>
                    <label style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                      <input
                        type="radio"
                        name="scenario-launch"
                        value="amaas"
                        checked={form.scenario === "amaas"}
                        onChange={(e) => updateForm("scenario", e.target.value as "ft" | "amaas")}
                      />
                      <span>åŸºäº AMaaS</span>
                    </label>
                  </div>
                </div>

                {/* AMaaS API é…ç½®ï¼ˆä»…åœ¨ AMaaS åœºæ™¯æ˜¾ç¤ºï¼‰ */}
                {form.scenario === "amaas" && (
                  <>
                    <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>AMaaS API é…ç½®</h3>
                    <div className="form-grid">
                      <label>
                        AMaaS API ç«¯å£
                        <input
                          type="number"
                          value={form.amaas_api_port || 10001}
                          onChange={(e) => updateForm("amaas_api_port", parseInt(e.target.value))}
                          placeholder="é»˜è®¤: 10001"
                          min="1024"
                          max="65535"
                        />
                      </label>

                      <label>
                        AMaaS ç”¨æˆ·å
                        <input
                          type="text"
                          value={form.amaas_api_user || "admin"}
                          onChange={(e) => updateForm("amaas_api_user", e.target.value)}
                          placeholder="é»˜è®¤: admin"
                        />
                      </label>

                      <label>
                        AMaaS å¯†ç 
                        <input
                          type="password"
                          value={form.amaas_api_passwd || ""}
                          onChange={(e) => updateForm("amaas_api_passwd", e.target.value)}
                          placeholder="AMaaS API å¯†ç "
                        />
                      </label>
                    </div>
                  </>
                )}

                {/* SSH é…ç½® */}
                <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>SSH é…ç½®</h3>
                <div className="form-grid">
                  <label>
                    SSH ä¸»æœº *
                    <input
                      type="text"
                      value={form.ssh_user ? `${form.ssh_user}@${form.amaas_ip || ""}` : form.amaas_ip || ""}
                      onChange={(e) => {
                        const value = e.target.value;
                        if (value.includes("@")) {
                          const [user, host] = value.split("@");
                          updateForm("ssh_user", user);
                          updateForm("amaas_ip", host);
                        } else {
                          updateForm("amaas_ip", value);
                        }
                      }}
                      placeholder="user@192.168.1.100"
                      required
                    />
                  </label>

                  <label>
                    SSH å¯†ç 
                    <input
                      type="password"
                      value={form.ssh_password || ""}
                      onChange={(e) => updateForm("ssh_password", e.target.value)}
                      placeholder="SSH å¯†ç "
                    />
                  </label>

                  <label>
                    SSH ç«¯å£
                    <input
                      type="number"
                      value={form.ssh_port || 22}
                      onChange={(e) => updateForm("ssh_port", parseInt(e.target.value))}
                      placeholder="é»˜è®¤: 22"
                    />
                  </label>
                </div>

                {/* æ¨¡å‹å¯åŠ¨é…ç½® */}
                <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æ¨¡å‹å¯åŠ¨é…ç½®</h3>
                <div className="form-grid">
                  <label>
                    æ¨¡å‹è·¯å¾„ *
                    <input
                      type="text"
                      value={form.model_path || ""}
                      onChange={(e) => updateForm("model_path", e.target.value)}
                      placeholder="ä¾‹å¦‚: DeepSeek-V3-0324-GPU-weight"
                      required
                    />
                  </label>

                  <label>
                    TPï¼ˆTensor Parallelismï¼‰
                    <input
                      type="number"
                      value={form.model_tp || 1}
                      onChange={(e) => updateForm("model_tp", parseInt(e.target.value))}
                      placeholder="é»˜è®¤: 1"
                      min="1"
                    />
                  </label>

                  {/* æ¨¡å‹æ¨¡å¼ä»…åœ¨ FT åœºæ™¯æ˜¾ç¤º */}
                  {form.scenario === "ft" && (
                    <label>
                      æ¨¡å‹æ¨¡å¼
                      <select
                        value={form.model_mode || "correct"}
                        onChange={(e) => updateForm("model_mode", e.target.value)}
                      >
                        <option value="correct">correctï¼ˆæ­£ç¡®æ€§ï¼‰</option>
                        <option value="perf">perfï¼ˆæ€§èƒ½ï¼‰</option>
                      </select>
                    </label>
                  )}

                  <label>
                    æ¨¡å‹ç«¯å£
                    <input
                      type="number"
                      value={form.model_port || 30000}
                      onChange={(e) => updateForm("model_port", parseInt(e.target.value))}
                      placeholder="é»˜è®¤: 30000"
                      min="1024"
                      max="65535"
                    />
                  </label>
                </div>

                {/* æµ‹è¯•å‚æ•° */}
                <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æµ‹è¯•å‚æ•°</h3>
                <div className="form-grid">
                  <label>
                    å¹¶å‘åº¦ *
                    <input
                      type="text"
                      value={form.concurrency || ""}
                      onChange={(e) => updateForm("concurrency", e.target.value)}
                      onBlur={(e) => updateForm("concurrency", e.target.value.trim())}
                      placeholder="ä¾‹å¦‚: 4 æˆ– 1 10 20 30 40"
                      required
                    />
                  </label>

                  <label>
                    è¯·æ±‚æ•° *
                    <input
                      type="text"
                      value={form.request_number || ""}
                      onChange={(e) => updateForm("request_number", e.target.value)}
                      onBlur={(e) => updateForm("request_number", e.target.value.trim())}
                      placeholder="ä¾‹å¦‚: 100 æˆ– 10 50 100 200"
                      required
                    />
                  </label>

                  <label>
                    æµ‹è¯•è½®æ¬¡
                    <input
                      type="number"
                      value={form.loop || 1}
                      onChange={(e) => updateForm("loop", parseInt(e.target.value))}
                      placeholder="é»˜è®¤: 1"
                      min="1"
                    />
                  </label>

                  <label>
                    è¾“å…¥é•¿åº¦ *
                    <input
                      type="number"
                      value={form.input_length}
                      onChange={(e) => updateForm("input_length", parseInt(e.target.value))}
                      placeholder="ä¾‹å¦‚: 512"
                      required
                    />
                  </label>

                  <label>
                    è¾“å‡ºé•¿åº¦ *
                    <input
                      type="number"
                      value={form.output_length}
                      onChange={(e) => updateForm("output_length", parseInt(e.target.value))}
                      placeholder="ä¾‹å¦‚: 512"
                      required
                    />
                  </label>
                </div>

                {/* æµ‹è¯•é€‰é¡¹ */}
                <h3 style={{ marginTop: "1rem", marginBottom: "0.5rem", fontSize: "1rem", fontWeight: "600" }}>æµ‹è¯•é€‰é¡¹</h3>
                <div className="form-grid">
                  <label>
                    Warmup
                    <input
                      type="checkbox"
                      checked={form.warmup}
                      onChange={(e) => updateForm("warmup", e.target.checked)}
                    />
                  </label>

                  <label>
                    æµ‹è¯•å®Œæˆååœæ­¢æ¨¡å‹
                    <input
                      type="checkbox"
                      checked={form.stop_model_after_test || false}
                      onChange={(e) => updateForm("stop_model_after_test", e.target.checked)}
                    />
                  </label>
                </div>

                {/* æ“ä½œæŒ‰é’® */}
                <div style={{ marginTop: "1.5rem", display: "flex", gap: "1rem" }}>
                  <button
                    onClick={async () => {
                      setLoading(true);
                      setMessage(null);
                      setError(null);
                      try {
                        const payload: any = {
                          base: form.scenario as "amaas" | "ft",
                          skip_launch: false,
                          ip: form.amaas_ip || "",
                          port: form.scenario === "amaas" ? 10011 : form.model_port,
                          model: form.model_path || form.model,
                          tokenizer_path: form.tokenizer_path || undefined,
                          ssh_user: form.ssh_user || "",
                          ssh_password: form.ssh_password || undefined,
                          ssh_port: form.ssh_port || 22,
                          parallel: form.concurrency || "1",
                          number: form.request_number || "100",
                          input_length: form.input_length,
                          output_length: form.output_length,
                          loop: form.loop || 1,
                          debug: form.debug || false,
                          warmup: form.warmup,
                          keep_model: !form.stop_model_after_test,
                        };

                        // FT åœºæ™¯éœ€è¦é¢å¤–å‚æ•°
                        if (form.scenario === "ft") {
                          payload.tp = form.model_tp || 1;
                          payload.launch_timeout = 900;
                        }

                        const response = await runPerfTest(payload);
                        setMessage(
                          `ä»»åŠ¡ ${response.task_id} å·²åˆ›å»ºï¼Œæ¨¡å‹å°†è‡ªåŠ¨å¯åŠ¨`,
                        );
                        await loadTasks();
                      } catch (err) {
                        setError(err instanceof Error ? err.message : "å¯åŠ¨å¤±è´¥");
                      } finally {
                        setLoading(false);
                      }
                    }}
                    disabled={loading}
                  >
                    {loading ? "å¯åŠ¨ä¸­..." : "æ‹‰èµ·æ¨¡å‹å¹¶æµ‹è¯•"}
                  </button>
                </div>

                {/* æ¶ˆæ¯æ˜¾ç¤º */}
                {message && <div className="success" style={{ marginTop: "1rem" }}>{message}</div>}
                {error && <div className="error" style={{ marginTop: "1rem" }}>{error}</div>}
              </div>
            )}
          </section>

          {/* ä»»åŠ¡åˆ—è¡¨ */}
          <section className="panel" style={{ marginTop: "1rem" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "1rem" }}>
              <h2 style={{ margin: 0 }}>ä»»åŠ¡åˆ—è¡¨</h2>
              {totalTasks > 0 && (
                <span style={{ color: "#666", fontSize: "0.875rem" }}>
                  å…± {totalTasks} æ¡ä»»åŠ¡ï¼Œç¬¬ {currentPage} / {totalPages} é¡µ
                </span>
              )}
            </div>
            {tasks.length === 0 ? (
              <p style={{ padding: "2rem", textAlign: "center", color: "#666" }}>
                æš‚æ— ä»»åŠ¡
              </p>
            ) : (
              <>
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>å¼•æ“</th>
                      <th>æ¨¡å‹</th>
                      <th>çŠ¶æ€</th>
                      <th>åˆ›å»ºè€…</th>
                      <th>åˆ›å»ºæ—¶é—´</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {tasks.map((task) => (
                      <tr key={task.id}>
                        <td>{task.id}</td>
                        <td>{task.engine}</td>
                        <td>{task.model}</td>
                        <td>
                          <span
                            style={{
                              padding: "0.25rem 0.5rem",
                              borderRadius: "4px",
                              fontSize: "0.875rem",
                              fontWeight: "600",
                              backgroundColor:
                                task.status === "completed"
                                  ? "#d1f2eb"
                                  : task.status === "running"
                                  ? "#fff3cd"
                                  : task.status === "failed"
                                  ? "#f8d7da"
                                  : "#e2e3e5",
                              color:
                                task.status === "completed"
                                  ? "#0d6832"
                                  : task.status === "running"
                                  ? "#856404"
                                  : task.status === "failed"
                                  ? "#721c24"
                                  : "#383d41",
                            }}
                          >
                            {task.status}
                          </span>
                        </td>
                        <td>
                          {task.user_email ? (
                            <span style={{
                              color: task.user_id === profile?.user_id ? "#28a745" : "#666",
                              fontWeight: task.user_id === profile?.user_id ? "600" : "normal"
                            }}>
                              {task.user_email}
                            </span>
                          ) : (
                            <span style={{ color: "#999" }}>æœªçŸ¥</span>
                          )}
                        </td>
                        <td>{new Date(task.created_at).toLocaleString()}</td>
                        <td>
                          <div style={{ display: "flex", gap: "0.5rem", flexWrap: "wrap" }}>
                            {task.result_path && (
                              <button
                                className="secondary"
                                onClick={() =>
                                  window.open(downloadUrl(task.id), "_blank")
                                }
                              >
                                ä¸‹è½½
                              </button>
                            )}
                            {task.result_path && !task.archived_path && (
                              <button
                                className="secondary"
                                onClick={() => handleArchive(task.id)}
                              >
                                å½’æ¡£
                              </button>
                            )}
                            <button
                              className="secondary"
                              onClick={() => handleViewLogs(task.id)}
                              style={{ color: "#007bff" }}
                            >
                              æ—¥å¿—
                            </button>
                            <button
                              className="secondary"
                              onClick={() => handleRetry(task.id)}
                              style={{ color: "#28a745" }}
                            >
                              é‡è¯•
                            </button>
                            {/* Only show cancel button if task belongs to current user and is queued/running */}
                            {(!task.user_id || task.user_id === profile?.user_id) &&
                             (task.status === "queued" || task.status === "running") && (
                              <button
                                className="secondary"
                                onClick={() => handleCancel(task.id)}
                                style={{ color: "#ff9800" }}
                              >
                                å–æ¶ˆ
                              </button>
                            )}
                            {/* Only show delete button if task belongs to current user */}
                            {(!task.user_id || task.user_id === profile?.user_id) && (
                              <button
                                className="secondary"
                                onClick={() => handleDelete(task.id)}
                                style={{ color: "#dc3545" }}
                              >
                                åˆ é™¤
                              </button>
                            )}
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>

                {/* Pagination controls */}
                {totalPages > 1 && (
                  <div style={{
                    display: "flex",
                    justifyContent: "center",
                    alignItems: "center",
                    gap: "1rem",
                    marginTop: "1.5rem",
                    paddingTop: "1rem",
                    borderTop: "1px solid #e0e0e0"
                  }}>
                    <button
                      className="secondary"
                      onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                      disabled={currentPage === 1}
                      style={{
                        opacity: currentPage === 1 ? 0.5 : 1,
                        cursor: currentPage === 1 ? "not-allowed" : "pointer"
                      }}
                    >
                      ä¸Šä¸€é¡µ
                    </button>
                    <span style={{ color: "#666" }}>
                      ç¬¬ {currentPage} / {totalPages} é¡µ
                    </span>
                    <button
                      className="secondary"
                      onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                      disabled={currentPage === totalPages}
                      style={{
                        opacity: currentPage === totalPages ? 0.5 : 1,
                        cursor: currentPage === totalPages ? "not-allowed" : "pointer"
                      }}
                    >
                      ä¸‹ä¸€é¡µ
                    </button>
                  </div>
                )}
              </>
            )}
          </section>
        </div>
      )}

      {activeTab === "correctness" && (
        <section className="panel">
          <h2>æ­£ç¡®æ€§æµ‹è¯•</h2>
          <p style={{ padding: "2rem", textAlign: "center", color: "#666" }}>
            æ­£ç¡®æ€§æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...
          </p>
        </section>
      )}

      {/* æ—¥å¿—æŸ¥çœ‹æ¨¡æ€æ¡† */}
      {showLogsModal && (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: "rgba(0, 0, 0, 0.5)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            zIndex: 1000,
          }}
          onClick={() => setShowLogsModal(false)}
        >
          <div
            style={{
              backgroundColor: "white",
              padding: "2rem",
              borderRadius: "8px",
              maxWidth: "90%",
              maxHeight: "90%",
              overflow: "auto",
              boxShadow: "0 4px 6px rgba(0, 0, 0, 0.1)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: "1rem",
              }}
            >
              <h2 style={{ margin: 0, color: "#1a1a1a", fontSize: "1.25rem" }}>ä»»åŠ¡ {logsTaskId} çš„æ‰§è¡Œæ—¥å¿—</h2>
              <button
                onClick={() => setShowLogsModal(false)}
                style={{
                  padding: "0.5rem 1rem",
                  cursor: "pointer",
                  border: "1px solid #d0d0d0",
                  borderRadius: "4px",
                  backgroundColor: "#f8f9fa",
                  color: "#333",
                  fontWeight: "500",
                }}
              >
                å…³é—­
              </button>
            </div>
            <pre
              style={{
                backgroundColor: "#2d2d2d",
                color: "#f8f8f2",
                padding: "1rem",
                borderRadius: "4px",
                overflow: "auto",
                maxHeight: "70vh",
                fontSize: "0.875rem",
                lineHeight: "1.5",
                whiteSpace: "pre-wrap",
                wordWrap: "break-word",
                border: "1px solid #444",
              }}
            >
              {currentLogs}
            </pre>
          </div>
        </div>
      )}
    </div>
  );
}

export default App;
